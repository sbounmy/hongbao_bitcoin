<% if view_type == :table %>
  <tr id="saved_hong_bao_<%= saved_hong_bao.id %>">
    <% if loading? %>
      <!-- Loading state with actual data + skeletons for loading values -->
      <td>
        <div class="font-bold"><%= time_ago_in_words(saved_hong_bao.gifted_at) if saved_hong_bao.gifted_at %> ago</div>
      </td>
      <td>
        <div class="badge badge-ghost badge-sm gap-1">
          <%= heroicon "clock", variant: :outline, class: "w-3 h-3" %>
          Loading
        </div>
      </td>
      <td>
        <div class="flex items-center gap-3">
          <%= image_tag saved_hong_bao.avatar_url, class: "w-8 h-8 rounded-full" %>
          <div>
            <div class="font-bold flex items-center gap-1">
              <%= saved_hong_bao.name %>
              <% if !readonly && saved_hong_bao.file.attached? %>
                <%= link_to download_saved_hong_bao_path(saved_hong_bao),
                    title: "Download recovery file" do %>
                  <%= heroicon "paper-clip", variant: :solid, class: "w-3.5 h-3.5" %>
                <% end %>
              <% end %>
            </div>
            <% if saved_hong_bao.notes.present? %>
              <div class="text-sm opacity-50"><%= truncate(saved_hong_bao.notes, length: 50) %></div>
            <% end %>
          </div>
        </div>
      </td>
      <td>
        <%= link_to "https://mempool.space/address/#{saved_hong_bao.address}",
            target: "_blank",
            rel: "noopener noreferrer",
            class: "font-mono text-xs hover:text-primary inline-flex items-center gap-1",
            title: saved_hong_bao.address do %>
          <span>
            <%= saved_hong_bao.address.first(8) %>...<%= saved_hong_bao.address.last(6) %>
            <%= heroicon "arrow-top-right-on-square", variant: :outline, class: "w-3 h-3 opacity-50 inline-block" %>
          </span>
        <% end %>
      </td>
      <td>
        <div class="font-bold">₿<%= number_with_precision(saved_hong_bao.initial_btc, precision: 8) %></div>
      </td>
      <td>
        <div class="skeleton h-4 w-20"></div>
        <div class="skeleton h-3 w-16 mt-1"></div>
      </td>
      <td>
        <div class="flex gap-2">
          <button class="btn btn-ghost btn-xs" disabled>
            <span class="loading loading-spinner loading-xs"></span>
            Fetching...
          </button>
        </div>
      </td>
    <% else %>
      <!-- Loaded state with actual data -->
      <td class="w-fit">
        <% if saved_hong_bao.gifted_at %>
          <div class="w-12 h-12 flex flex-col gap-1 items-center justify-center border border-base-300 rounded-lg">
            <div class="text-[10px] text-base-content/70 font-medium uppercase leading-none"><%= saved_hong_bao.gifted_at.strftime("%b") %></div>
            <div class="text-base font-bold leading-none"><%= saved_hong_bao.gifted_at.strftime("%-d") %></div>
          </div>
        <% end %>
      </td>
      <td>
        <% status_info = saved_hong_bao.status_display %>
        <div class="badge <%= status_info[:class] %> badge-sm gap-1">
          <%= heroicon status_info[:icon], variant: :outline, class: "w-3 h-3" %>
          <%= status_info[:text] %>
        </div>
      </td>
      <td>
        <div class="flex items-center gap-3">
          <%= image_tag saved_hong_bao.avatar_url, class: "w-8 h-8 rounded-full" %>
          <div>
            <div class="font-bold flex items-center gap-1">
              <%= saved_hong_bao.name %>
              <% if !readonly && saved_hong_bao.file.attached? %>
                <%= link_to download_saved_hong_bao_path(saved_hong_bao),
                    title: "Download recovery file" do %>
                  <%= heroicon "paper-clip", variant: :solid, class: "w-3.5 h-3.5 text-success" %>
                <% end %>
              <% end %>
            </div>
            <% if saved_hong_bao.notes.present? %>
              <div class="text-sm opacity-50"><%= truncate(saved_hong_bao.notes, length: 50) %></div>
            <% end %>
          </div>
        </div>
      </td>
      <td>
        <%= link_to "https://mempool.space/address/#{saved_hong_bao.address}",
            target: "_blank",
            rel: "noopener noreferrer",
            class: "font-mono text-xs hover:text-primary inline-flex items-center gap-1",
            title: saved_hong_bao.address do %>
          <span>
            <%= saved_hong_bao.address.first(8) %>...<%= saved_hong_bao.address.last(6) %>
            <%= heroicon "arrow-top-right-on-square", variant: :outline, class: "w-3 h-3 opacity-50 inline-block" %>
          </span>
        <% end %>
      </td>
      <td>
        <div class="font-bold">₿<%= number_with_precision(saved_hong_bao.initial_btc, precision: 8) %></div>
      </td>
      <td>
        <div>
          <div class="flex items-center gap-2">
            <span class="font-semibold">$<%= number_with_delimiter(saved_hong_bao.usd.round) %></span>
            <span class="<%= saved_hong_bao.usd_change > 0 ? 'text-success' : 'text-error' %> text-sm font-medium">
              <%= saved_hong_bao.usd_change > 0 ? '↑' : '↓' %><%= saved_hong_bao.balance_change_percentage.round %>%
            </span>
          </div>
          <div class="text-xs opacity-60">
            from $<%= number_with_delimiter(saved_hong_bao.initial_usd.round) %>
          </div>
        </div>
      </td>
      <td>
        <div class="flex gap-1">
          <% unless readonly %>
            <%= button_to(refresh_saved_hong_bao_path(saved_hong_bao), method: :post,
                class: "btn btn-ghost btn-sm btn-square",
                title: "Last updated: #{saved_hong_bao.last_fetched_at ? time_ago_in_words(saved_hong_bao.last_fetched_at) + ' ago' : 'Never'}") do %>
              <span><%= heroicon "arrow-path", variant: :outline, class: "w-4 h-4" %></span>
            <% end %>
          <% end %>
          <%= link_to(hong_bao_path(saved_hong_bao.address),
              class: "btn btn-ghost btn-sm btn-square",
              target: "_blank",
              title: "View details") do %>
            <span><%= heroicon "eye", variant: :outline, class: "w-4 h-4" %></span>
          <% end %>

          <!-- Edit button -->
          <% unless readonly %>
            <%= link_to edit_saved_hong_bao_path(saved_hong_bao),
                class: "btn btn-ghost btn-sm btn-square",
                data: { turbo_frame: "modal" },
                title: "Edit" do %>
              <%= heroicon "pencil", variant: :outline, class: "w-4 h-4" %>
            <% end %>
          <% end %>

          <!-- Dropdown for more actions -->
          <% unless readonly %>
            <div class="dropdown dropdown-end">
              <label tabindex="0" class="btn btn-ghost btn-sm btn-square">
                <%= heroicon "ellipsis-vertical", variant: :solid, class: "w-4 h-4" %>
              </label>
              <ul tabindex="0" class="dropdown-content menu p-2 shadow-lg bg-base-100 rounded-box w-40 z-50 border border-base-300">
                  <% if saved_hong_bao.may_mark_hodl? %>
                    <li>
                      <%= render SavedHongBaos::StatusFormComponent.new(
                          saved_hong_bao: saved_hong_bao,
                          status: "hodl",
                          confirm_text: "Mark #{saved_hong_bao.name} as HODL?") %>
                    </li>
                  <% end %>
                  <% if saved_hong_bao.may_mark_lost? %>
                    <li>
                      <%= render SavedHongBaos::StatusFormComponent.new(
                          saved_hong_bao: saved_hong_bao,
                          status: "lost",
                          confirm_text: "Mark #{saved_hong_bao.name} as lost?") %>
                    </li>
                  <% end %>
                  <% if saved_hong_bao.may_mark_withdrawn? %>
                    <li>
                      <%= render SavedHongBaos::StatusFormComponent.new(
                          saved_hong_bao: saved_hong_bao,
                          status: "withdrawn",
                          confirm_text: "Mark #{saved_hong_bao.name} as withdrawn?") %>
                    </li>
                  <% end %>
                  <li class="divider"></li>
                  <li>
                    <%= button_to(saved_hong_bao, method: :delete,
                        data: { turbo_confirm: "Remove #{saved_hong_bao.name}?" },
                        class: "text-xs text-error") do %>
                      <span class="flex items-center gap-1">
                        <%= heroicon "trash", variant: :outline, class: "w-3 h-3" %>
                        Remove
                      </span>
                    <% end %>
                  </li>
                  </ul>
                </div>
            <% end %>
          </div>
        </div>
      </td>
    <% end %>
  </tr>
<% else %>
  <!-- Mobile card view - Compact design -->
  <div id="saved_hong_bao_card_<%= saved_hong_bao.id %>" class="card bg-base-100 border border-base-300 shadow-sm">
    <div class="card-body p-3">
      <% if loading? %>
        <!-- Loading state with actual data + skeletons for loading values -->
        <div class="flex items-center justify-between">
          <!-- Date (show actual date) -->
          <div class="flex-shrink-0 text-center mr-2">
            <% if saved_hong_bao.gifted_at %>
              <div class="border border-base-300 rounded-lg px-2 py-1">
                <div class="text-xs text-base-content/70 font-medium uppercase"><%= saved_hong_bao.gifted_at.strftime("%b") %></div>
                <div class="text-lg font-bold leading-none"><%= saved_hong_bao.gifted_at.strftime("%-d") %></div>
              </div>
            <% else %>
              <div class="border border-base-300 rounded-lg px-2 py-1">
                <div class="text-xs text-base-content/70 font-medium">-</div>
                <div class="text-lg font-bold leading-none">-</div>
              </div>
            <% end %>
          </div>
          <!-- Avatar, name, address (show actual data) -->
          <div class="flex items-center gap-2 min-w-0 flex-1">
            <%= image_tag saved_hong_bao.avatar_url, class: "w-8 h-8 rounded-full flex-shrink-0" %>
            <div class="min-w-0">
              <div class="font-semibold text-sm truncate">
                <%= saved_hong_bao.name %>
              </div>
              <div class="font-mono text-xs text-base-content/60 truncate">
                <%= saved_hong_bao.address.first(8) %>...<%= saved_hong_bao.address.last(6) %>
              </div>
            </div>
          </div>
          <!-- Balance skeleton (actually loading) -->
          <div class="text-right px-2">
            <div class="skeleton h-4 w-20 ml-auto mb-1"></div>
            <div class="skeleton h-3 w-28 ml-auto"></div>
          </div>
          <!-- Actions skeleton -->
          <div class="flex items-center gap-1">
            <div class="badge badge-ghost badge-sm animate-pulse">
              <%= heroicon "clock", variant: :outline, class: "w-3 h-3" %>
            </div>
            <div class="skeleton h-6 w-6 rounded"></div>
          </div>
        </div>
      <% else %>
        <!-- Loaded state with actual data -->
        <div class="flex items-center justify-between">
          <!-- Date Column (First) -->
          <div class="flex-shrink-0 text-center mr-2">
            <% if saved_hong_bao.gifted_at %>
              <div class="border border-base-300 rounded-lg px-2 py-1">
                <div class="text-xs text-base-content/70 font-medium uppercase"><%= saved_hong_bao.gifted_at.strftime("%b") %></div>
                <div class="text-lg font-bold leading-none"><%= saved_hong_bao.gifted_at.strftime("%-d") %></div>
              </div>
            <% else %>
              <div class="border border-base-300 rounded-lg px-2 py-1">
                <div class="text-xs text-base-content/70 font-medium">-</div>
                <div class="text-lg font-bold leading-none">-</div>
              </div>
            <% end %>
          </div>

          <!-- Avatar, name, address -->
          <div class="flex items-center gap-2 min-w-0 flex-1">
            <%= image_tag saved_hong_bao.avatar_url, class: "w-8 h-8 rounded-full flex-shrink-0" %>
            <div class="min-w-0">
              <div class="font-semibold text-sm truncate flex items-center gap-1">
                <%= saved_hong_bao.name %>
                <% if !readonly && saved_hong_bao.file.attached? %>
                  <%= link_to download_saved_hong_bao_path(saved_hong_bao),
                      title: "Download recovery file" do %>
                    <%= heroicon "paper-clip", variant: :solid, class: "w-3 h-3" %>
                  <% end %>
                <% end %>
              </div>
              <div class="font-mono text-xs text-base-content/60 truncate">
                <%= saved_hong_bao.address.first(6) %>...<%= saved_hong_bao.address.last(4) %>
              </div>
            </div>
          </div>

          <!-- Balance and Value Progression -->
          <div class="text-right px-2">
            <div class="font-semibold text-sm">₿<%= number_with_precision(saved_hong_bao.initial_btc, precision: 8) %></div>
            <div class="text-xs text-base-content/70">
              $<%= number_with_delimiter(saved_hong_bao.initial_usd.round) %> → $<%= number_with_delimiter(saved_hong_bao.usd.round) %>
              <span class="<%= saved_hong_bao.usd_change > 0 ? 'text-success' : 'text-error' %> font-medium">
                (<%= saved_hong_bao.usd_change > 0 ? '↑' : '↓' %><%= saved_hong_bao.balance_change_percentage.round %>%)
              </span>
            </div>
          </div>

          <!-- Right side: Status badge and actions -->
          <div class="flex items-center gap-1">
            <% status_info = saved_hong_bao.status_display %>
            <div class="badge <%= status_info[:class] %> badge-sm">
              <%= heroicon status_info[:icon], variant: :outline, class: "w-3 h-3" %>
              <span class="hidden">HODL</span>
            </div>

            <!-- Edit button for mobile -->
            <% unless readonly %>
              <%= link_to edit_saved_hong_bao_path(saved_hong_bao),
                  class: "btn btn-ghost btn-xs btn-square",
                  data: { turbo_frame: "modal" },
                  title: "Edit" do %>
                <%= heroicon "pencil", variant: :outline, class: "w-3 h-3" %>
              <% end %>
            <% end %>

            <div class="dropdown dropdown-end">
              <label tabindex="0" class="btn btn-ghost btn-xs btn-square">
                <%= heroicon "ellipsis-vertical", variant: :solid, class: "w-4 h-4" %>
              </label>
              <ul tabindex="0" class="dropdown-content menu p-2 shadow-lg bg-base-100 rounded-box w-40 z-50 border border-base-300">
                <li>
                  <%= link_to hong_bao_path(saved_hong_bao.address), target: "_blank", class: "text-xs" do %>
                    <span class="flex items-center gap-1">
                      <%= heroicon "eye", variant: :outline, class: "w-3 h-3" %>
                      View
                    </span>
                  <% end %>
                </li>
                <% unless readonly %>
                  <% if saved_hong_bao.may_mark_hodl? %>
                    <li>
                      <%= render SavedHongBaos::StatusFormComponent.new(
                          saved_hong_bao: saved_hong_bao,
                          status: "hodl",
                          confirm_text: "Mark #{saved_hong_bao.name} as HODL?") %>
                    </li>
                  <% end %>
                  <% if saved_hong_bao.may_mark_lost? %>
                    <li>
                      <%= render SavedHongBaos::StatusFormComponent.new(
                          saved_hong_bao: saved_hong_bao,
                          status: "lost",
                          confirm_text: "Mark #{saved_hong_bao.name} as lost?") %>
                    </li>
                  <% end %>
                  <% if saved_hong_bao.may_mark_withdrawn? %>
                    <li>
                      <%= render SavedHongBaos::StatusFormComponent.new(
                          saved_hong_bao: saved_hong_bao,
                          status: "withdrawn",
                          confirm_text: "Mark #{saved_hong_bao.name} as withdrawn?") %>
                    </li>
                  <% end %>
                  <li class="divider"></li>
                  <li>
                    <%= button_to saved_hong_bao, method: :delete,
                        data: { turbo_confirm: "Remove #{saved_hong_bao.name}?" },
                        class: "text-xs text-error" do %>
                      <span class="flex items-center gap-1">
                        <%= heroicon "trash", variant: :outline, class: "w-3 h-3" %>
                        Remove
                      </span>
                    <% end %>
                  </li>
                <% end %>
              </ul>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>