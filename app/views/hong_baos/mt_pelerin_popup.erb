<%= turbo_stream.append_all "body" do %>
  <div id="mt-pelerin-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40"></div>
  <script>
    (() => {
      const overlay = document.getElementById('mt-pelerin-overlay');

      const checkMtPelerin = setInterval(() => {
        if (window.showMtpModal && typeof window.showMtpModal === 'function') {
          clearInterval(checkMtPelerin);

          showMtpModal({
            _ctkn: '954139b2-ef3e-4914-82ea-33192d3f43d3',
            type: 'direct-link',
            lang: '<%= I18n.locale %>',
            tab: 'buy',
            tabs: 'buy',
            net: '<%= Rails.env.production? ? 'bitcoin_mainnet' : 'bitcoin_testnet' %>',
            nets: '<%= Rails.env.production? ? 'bitcoin_mainnet' : 'bitcoin_testnet' %>',
            curs: 'EUR,USD,SGD',
            ctry: 'FR',
            primary: '#F04747',
            success: '#FFB636',
            amount: '<%= @hong_bao.amount %>',
            mylogo: '<%= asset_url("hongbao-bitcoin-logo-520.png") %>',
            addr: '<%= @hong_bao.address %>',
            code: '<%= @hong_bao.mt_pelerin_request_code %>',
            hash: '<%= @hong_bao.mt_pelerin_request_hash %>'
          });

          // Check for iframe presence every 100ms
          let modalPresent = false;
          const checkModal = setInterval(() => {
            const iframe = document.querySelector('iframe[src*="mtpelerin"]');

            if (iframe && !modalPresent) {
              modalPresent = true;
              console.log('Modal opened');
            } else if (!iframe && modalPresent) {
              console.log('Modal closed');
              overlay.remove();
              clearInterval(checkModal);
            }
          }, 100);
        }
      }, 100);

      setTimeout(() => clearInterval(checkMtPelerin), 5000);
    })();
  </script>
<% end %>