<%= render "shared/header" %>

<div class="min-h-screen bg-base-100">
  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Page Header with Actions -->
    <div class="flex flex-col sm:flex-row justify-between items-start gap-4 mb-8">
      <div class="flex-1">
        <h1 class="text-4xl font-bold text-base-content mb-2"><%= @saved_hong_bao.name %></h1>
        <div class="flex items-center gap-2">
          <p class="text-sm text-base-content/60 font-mono"><%= @saved_hong_bao.address %></p>
          <%= link_to addr_path(@saved_hong_bao.address),
              class: "btn btn-ghost btn-xs",
              target: "_blank",
              title: "View on blockchain" do %>
            <%= heroicon "arrow-top-right-on-square", variant: :outline, class: "w-3 h-3" %>
          <% end %>
        </div>
      </div>
      <%= button_to @saved_hong_bao,
          method: :delete,
          data: { turbo_confirm: "Are you sure you want to remove #{@saved_hong_bao.name}?" },
          class: "btn btn-error btn-outline" do %>
        <%= heroicon "trash", variant: :outline, class: "w-4 h-4 mr-2" %>
        Remove
      <% end %>
    </div>

    <!-- Balance Stats -->
    <div class="stats stats-vertical lg:stats-horizontal shadow w-full mb-8">
      <div class="stat">
        <div class="stat-figure text-primary">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
        </div>
        <div class="stat-title">Current Balance</div>
        <div class="stat-value"><%= number_with_precision(@saved_hong_bao.btc, precision: 8) %></div>
        <div class="stat-desc">BTC â€¢ $<%= number_with_delimiter(@saved_hong_bao.usd.round(2)) %></div>
      </div>

      <div class="stat">
        <div class="stat-figure">
          <% status = @saved_hong_bao.status %>
          <div class="badge badge-lg <%= status[:class] %> gap-2">
            <%= heroicon status[:icon], variant: :outline, class: "w-4 h-4" %>
            <%= status[:text].capitalize %>
          </div>
        </div>
        <div class="stat-title">USD Value Change</div>
        <div class="stat-value text-2xl">
          <% if @saved_hong_bao.initial_usd && @saved_hong_bao.usd_change != 0 %>
            <span class="<%= @saved_hong_bao.usd_change > 0 ? 'text-success' : 'text-error' %>">
              <%= @saved_hong_bao.usd_change > 0 ? 'â†‘' : 'â†“' %>
              <%= @saved_hong_bao.balance_change_percentage.abs %>%
            </span>
          <% else %>
            <span class="text-base-content/50">No change</span>
          <% end %>
        </div>
        <div class="stat-desc">
          <% if @saved_hong_bao.initial_usd %>
            From $<%= number_with_delimiter(@saved_hong_bao.initial_usd.round(2)) %>
          <% elsif @saved_hong_bao.gifted_at %>
            Since <%= @saved_hong_bao.gifted_at.strftime("%b %d, %Y") %>
          <% end %>
        </div>
      </div>

      <div class="stat">
        <div class="stat-title">Initial Balance</div>
        <div class="stat-value text-2xl"><%= number_with_precision(@saved_hong_bao.initial_balance.to_f / 100_000_000, precision: 8) %></div>
        <div class="stat-desc">
          <% if @saved_hong_bao.initial_usd %>
            $<%= number_with_delimiter(@saved_hong_bao.initial_usd.round(2)) %> at creation
          <% else %>
            BTC at creation
          <% end %>
        </div>
      </div>

      <div class="stat">
        <div class="stat-title">BTC Change</div>
        <div class="stat-value text-2xl <%= @saved_hong_bao.balance_change >= 0 ? 'text-success' : 'text-error' %>">
          <%= @saved_hong_bao.balance_change >= 0 ? '+' : '' %><%= number_with_precision(@saved_hong_bao.balance_change.to_f / 100_000_000, precision: 8) %>
        </div>
        <div class="stat-desc">
          <% if @saved_hong_bao.initial_usd && @saved_hong_bao.usd_change != 0 %>
            $<%= @saved_hong_bao.usd_change >= 0 ? '+' : '' %><%= number_with_delimiter(@saved_hong_bao.usd_change.round(2)) %> USD
          <% else %>
            BTC difference
          <% end %>
        </div>
      </div>
    </div>

    <!-- Notes (if present) -->
    <% if @saved_hong_bao.notes.present? %>
      <div class="alert alert-info mb-8">
        <div>
          <h3 class="font-bold">Notes</h3>
          <div class="text-sm"><%= @saved_hong_bao.notes %></div>
        </div>
      </div>
    <% end %>

    <!-- Transaction History -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title mb-4">
          <%= heroicon "clock", variant: :outline, class: "w-6 h-6" %>
          Transaction History
        </h2>

        <% if @transactions.any? %>
          <div class="overflow-x-auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Confirmations</th>
                  <th>Transaction</th>
                </tr>
              </thead>
              <tbody>
                <% @transactions.each do |tx| %>
                  <tr class="hover">
                    <td>
                      <div>
                        <div class="font-bold"><%= tx.timestamp&.strftime("%b %d, %Y") || "Pending" %></div>
                        <div class="text-sm opacity-50"><%= tx.timestamp&.strftime("%H:%M") %></div>
                      </div>
                    </td>
                    <td>
                      <span class="badge <%= tx.received? ? 'badge-success' : 'badge-error' %> badge-sm">
                        <%= tx.received? ? 'IN' : 'OUT' %>
                      </span>
                    </td>
                    <td>
                      <span class="font-mono <%= tx.received? ? 'text-success' : 'text-error' %>">
                        <%= tx.received? ? '+' : '-' %><%= number_with_precision(tx.amount_btc, precision: 8) %>
                      </span>
                    </td>
                    <td>
                      <% if tx.confirmations > 0 %>
                        <div class="badge badge-success badge-outline">
                          <%= number_with_delimiter(tx.confirmations) %> conf
                        </div>
                      <% else %>
                        <div class="badge badge-warning">Pending</div>
                      <% end %>
                    </td>
                    <td>
                      <div class="flex items-center gap-1">
                        <span class="font-mono text-xs"><%= tx.txid[0..7] %>...</span>
                        <%= link_to "https://blockstream.info/#{Current.testnet? ? 'testnet/' : ''}tx/#{tx.txid}",
                            target: "_blank",
                            class: "btn btn-ghost btn-xs" do %>
                          <%= heroicon "arrow-top-right-on-square", variant: :outline, class: "w-3 h-3" %>
                        <% end %>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="flex flex-col items-center justify-center py-12">
            <div class="text-6xl mb-4">ðŸ“­</div>
            <p class="text-xl font-semibold text-base-content/70">No transactions yet</p>
            <p class="text-sm text-base-content/50 mt-2">Transactions will appear here once they occur</p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex justify-between mt-8">
      <%= link_to saved_hong_baos_path, class: "btn btn-ghost" do %>
        <%= heroicon "arrow-left", variant: :outline, class: "w-5 h-5 mr-2" %>
        Back to List
      <% end %>

      <%= link_to addr_path(@saved_hong_bao.address),
          class: "btn btn-primary",
          target: "_blank" do %>
        View on Blockchain
        <%= heroicon "arrow-top-right-on-square", variant: :outline, class: "w-4 h-4 ml-2" %>
      <% end %>
    </div>
  </div>
</div>