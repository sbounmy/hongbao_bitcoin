<!DOCTYPE html>
<html lang="<%= I18n.locale %>">
  <head>
    <%# Mobile Viewport Meta Tags %>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <%# Primary Meta Tags %>
    <title><%= content_for?(:title) ? yield(:title) : t('.meta.title') %></title>
    <meta name="title" content="<%= content_for?(:title) ? yield(:title) : t('.meta.title') %>">
    <meta name="description" content="<%= content_for?(:description) ? yield(:description) : t('.meta.description') %>">
    <meta name="keywords" content="<%= content_for?(:keywords) ? yield(:keywords) : t('.meta.keywords') %>">

    <%# Open Graph / Facebook %>
    <meta property="og:type" content="website">
    <meta property="og:title" content="<%= content_for?(:title) ? yield(:title) : t('.meta.title') %>">
    <meta property="og:description" content="<%= content_for?(:description) ? yield(:description) : t('.meta.description') %>">
    <meta property="og:image" content="<%= content_for?(:og_image) ? yield(:og_image) : image_url('og-image.jpg') %>">

    <%# Twitter %>
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="<%= content_for?(:title) ? yield(:title) : t('.meta.title') %>">
    <meta property="twitter:description" content="<%= t('.meta.description') %>">
    <meta property="twitter:image" content="<%= content_for?(:og_image) ? yield(:og_image) : image_url('og-image.jpg') %>">

    <%= canonical_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

    <%# Includes all stylesheet files in app/views/stylesheets %>
    <%= stylesheet_link_tag "application", "tailwind", "data-turbo-track": "reload" %>
    <%# Support importmap for legacy browsers https://caniuse.com/import-maps %>
    <script defer data-domain="hongbaob.tc" src="https://plausible.io/js/script.js"></script>
    <script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>

    <%= theme_css(current_theme) %>
    <%= action_cable_meta_tag %>
    <%= csp_meta_tag %>
    <%# javascript_include_tag "application", "data-turbo-track": "reload", type: "module" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload" %>
    <%= render(AnalyticsComponent.new(renderable: !content_for?(:skip_analytics))) %>
  </head>

  <body class="bg-primary min-h-screen">
    <div class="min-h-screen">
      <%# Main Pokedex Content %>
      <div class="flex flex-col min-h-screen">
        <%# Pokedex Header - Fixed %>
        <div class="bg-primary fixed top-0 left-0 right-0 z-50 pt-4 md:pt-6 px-4 md:px-6">
          <%# Top section with buttons %>
          <div class="flex items-start gap-4 md:gap-6">
            <%# FAB Button (replaces static lens) %>
            <%= render Btcdex::FabComponent.new do |fab| %>
              <% fab.with_action(label: "Home", icon: "home", href: dashboard_path) %>
              <% fab.with_action(label: "Create", icon: "plus", href: new_paper_path) %>
              <% fab.with_action(label: "Scan", icon: "qr-code", href: hong_baos_path) %>
              <% fab.with_action(label: "Collection", icon: "rectangle-stack", href: explore_papers_path) %>
            <% end %>

            <%# LED indicators %>
            <div class="flex items-center gap-2 md:gap-3">
              <%# BTC Price LED (1st LED) %>
              <%= render Btcdex::BtcPriceLedComponent.new %>

              <%# Transaction Fee LED (2nd LED) %>
              <%= render Btcdex::TxFeeLedComponent.new %>

              <%# Placeholder LED (3rd - future feature) %>
              <div class="tooltip tooltip-bottom" data-tip="Coming soon">
                <div class="w-5 h-5 rounded-full bg-success border-2 border-success/50 shadow-inner"></div>
              </div>
            </div>

            <%# Token balance + User avatar - only show when authenticated %>
            <% if authenticated? %>
              <%= render Tokens::BadgeComponent.new(user: current_user, class_name: "badge-lg") %>
            <% end %>

            <%# Spacer %>
            <div class="flex-1"></div>
          </div>

          <%# Angled border line - SVG for smooth continuous joints %>
          <div class="relative h-14 -mt-6 md:-mt-8" style="overflow: visible;">
            <svg class="absolute inset-0 w-full h-full" style="overflow: visible;" preserveAspectRatio="xMinYMid meet">
              <%# Black border (background, thicker) %>
              <path
                d="M -18 48 L 90 48 L 115 8 L 2000 8"
                fill="none"
                stroke="black"
                stroke-width="12"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <%# Dark red fill (foreground, thinner) %>
              <path
                d="M -18 48 L 90 48 L 115 8 L 2000 8"
                fill="none"
                stroke="#991b1b"
                stroke-width="8"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </div>
        </div>

        <%# Main Screen Area (with top padding for fixed header) %>
        <div class="flex-1 bg-primary px-4 md:px-6 <%= content_for?(:footer) ? "pb-4" : "pb-20"-%> md:pb-6 pt-26 md:pt-32">
          <div class="flex">
            <%# Tab Navigation - Desktop only %>
            <%= render "btcdex/tab_nav" %>

            <%# Dark screen container %>
            <div class="bg-base-100 rounded-2xl md:rounded-l-none shadow-2xl flex-1 min-w-0 flex flex-col">
              <%# Screen bezel/header - can be customized via content_for(:screen_header) %>
              <div class="bg-base-200 rounded-t-xl md:rounded-tl-none px-4 py-2 border-b border-secondary/20 sticky top-22 md:top-28 z-10">
                <% if content_for?(:screen_header) %>
                  <%= yield :screen_header %>
                <% else %>
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                      <div class="w-2 h-2 rounded-full bg-success animate-pulse"></div>
                      <span class="text-base-content/60 text-xs font-mono">BTCDEX v1.0</span>
                    </div>
                    <span class="text-base-content/40 text-xs">SCAN TO COLLECT</span>
                  </div>
                <% end %>
              </div>

              <%# Content area - body scrolls now %>
              <div class="flex-1">
                <% if flash.any? %>
                  <%= render FlashMessagesComponent.new(flash: flash) %>
                <% end %>
                <%= yield %>
              </div>
            </div>
          </div>
        </div>

        <%# Pokedex D-Pad Dock (mobile only) %>
        <% if content_for?(:footer) %>
          <%= yield :footer %>
        <% else %>
          <%= render Btcdex::DockComponent.new do |dock| %>
            <% dock.with_item(label: "Home", icon: "home", href: dashboard_path) %>
            <% dock.with_item(label: "Scan", icon: "qr-code", href: new_paper_path, primary: true) %>
            <% dock.with_item(label: "Collection", icon: "rectangle-stack", href: explore_papers_path) %>
            <% if authenticated? && current_user %>
              <% dock.with_avatar do %>
                <label for="user-bottom-sheet" class="cursor-pointer">
                  <div class="w-7 h-7 rounded-full overflow-hidden ring-2 ring-white/50">
                    <%= image_tag current_user.avatar.attached? ? current_user.avatar : gravatar_url(current_user.email),
                        alt: current_user.firstname || current_user.email,
                        class: "w-full h-full object-cover" %>
                  </div>
                </label>
              <% end %>
            <% else %>
              <% dock.with_avatar do %>
                <%= link_to login_path, class: "flex items-center justify-center #{(current_page?(login_path) || current_page?(new_password_path)) ? 'dock-active' : ''}" do %>
                  <%= heroicon "user", variant: :outline, class: "w-6 h-6 text-white/70" %>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      </div>
    </div>

    <%= turbo_frame_tag "modal" %>

    <%# User bottom sheet menu %>
    <% if authenticated? && current_user %>
      <%= render Btcdex::BottomSheetComponent.new(id: "user-bottom-sheet", user: current_user) %>
    <% end %>
  </body>
</html>
