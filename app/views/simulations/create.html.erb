<%#
  This view is rendered via Turbo Frame for both full simulator and stats_only mode
%>
<% stats_only = params[:stats_only] == "true" %>

<%= turbo_frame_tag "simulation_results" do %>
  <% if @result.success? && @result.payload[:event_hong_baos]&.any? %>
    <!-- Stats Overview -->
    <%= render Simulations::StatsComponent.new(event_hong_baos: @result.payload[:event_hong_baos]) %>

    <% unless stats_only %>
      <!-- Chart -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body p-4 lg:p-6">
          <%= render Charts::SimulationChartComponent.new(
            event_hong_baos: @result.payload[:event_hong_baos],
            chart_data: @result.payload[:chart_data]
          ) %>
        </div>
      </div>

      <!-- Event List -->
      <div class="card bg-base-100 shadow-xl mt-6">
        <div class="card-body">
          <h3 class="card-title text-lg mb-4">Gift History</h3>
          <div class="overflow-x-auto">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Event</th>
                  <th>Date</th>
                  <th>Gift Amount</th>
                  <th>BTC Price</th>
                  <th>Sats Received</th>
                  <th>Current Value</th>
                </tr>
              </thead>
              <tbody>
                <% @result.payload[:event_hong_baos].each do |hong_bao| %>
                  <tr>
                    <td>
                      <span class="flex items-center gap-2">
                        <span class="text-lg"><%= hong_bao.event_emoji %></span>
                        <span><%= hong_bao.name %></span>
                      </span>
                    </td>
                    <td><%= hong_bao.gifted_at.strftime("%b %d, %Y") %></td>
                    <td class="font-mono">$<%= number_with_precision(hong_bao.initial_usd, precision: 2) %></td>
                    <td class="font-mono">$<%= number_with_delimiter(hong_bao.spot_buy.usd.round) %></td>
                    <td class="font-mono"><%= number_with_delimiter(hong_bao.initial_sats) %></td>
                    <td class="font-mono font-semibold">
                      $<%= number_with_precision(hong_bao.btc * Spot.current(:usd).usd, precision: 2) %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    <% end %>
  <% elsif @result.error? %>
    <!-- Error state -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <div class="flex flex-col items-center justify-center py-12 text-center">
          <%= heroicon "exclamation-triangle", variant: :outline, class: "w-16 h-16 text-error mb-4" %>
          <h3 class="text-xl font-semibold text-base-content mb-2">
            Error in simulation
          </h3>
          <p class="text-base-content/70">
            <%= @result.error %>
          </p>
        </div>
      </div>
    </div>
  <% else %>
    <!-- No results state -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <div class="flex flex-col items-center justify-center py-12 text-center">
          <%= heroicon "information-circle", variant: :outline, class: "w-16 h-16 text-info mb-4" %>
          <h3 class="text-xl font-semibold text-base-content mb-2">
            No events selected
          </h3>
          <p class="text-base-content/70">
            Please enter at least one gift amount to see your simulation.
          </p>
        </div>
      </div>
    </div>
  <% end %>
<% end %>