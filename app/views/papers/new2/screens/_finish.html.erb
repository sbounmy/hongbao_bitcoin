<%# Screen 2: Finish - Download + Fund + Track (Offline Mode) %>
<div class="flex flex-col h-full">

  <%# Scrollable content - fills remaining space %>
  <div class="flex-1 min-h-0 overflow-auto">
    <%# PDF Preview - click to expand fullscreen %>
    <div class="bg-base-200 cursor-pointer" data-action="click->pdf#expand">
      <%= render "papers/new2/preview_pdf",
          paper: paper,
          frame: frame,
          template_front_base64: template_front_base64,
          template_back_base64: template_back_base64,
          portrait_config: portrait_config %>
    </div>

    <%# Instagram-style list items %>
    <div class="divide-y divide-base-200">
      <%# Password row %>
      <%= render BottomSheetComponent.new(id: "password-drawer") do |sheet| %>
        <% sheet.with_trigger do %>
          <button type="button" class="w-full flex items-center justify-between px-4 py-3 hover:bg-base-200 transition-colors">
            <div class="flex items-center gap-3">
              <%= heroicon "lock-closed", variant: :outline, class: "w-5 h-5 text-base-content/70" %>
              <span class="text-base-content">Password</span>
              <span class="text-base-content/40 text-xs">(optional)</span>
            </div>
            <%= heroicon "chevron-right", variant: :mini, class: "w-5 h-5 text-base-content/40" %>
          </button>
        <% end %>
        <% sheet.with_header do %>PDF Password<% end %>
        <div class="p-4 space-y-3">
          <%= render PasswordMeterComponent.new(
            input_id: "pdf-password",
            name: "pdf_password",
            placeholder: "Enter password...",
            data_targets: { pdf: "password" },
            show_visibility_toggle: true,
            min_length: 8,
            require_uppercase: true,
            require_lowercase: true,
            require_numbers: true,
            require_special: false,
            show_requirements: false,
            show_meter: true,
            input_classes: "input input-bordered w-full pr-10 bg-base-200 border-base-content/20 placeholder-base-content/40"
          ) %>
          <p class="text-xs text-base-content/50">No recovery if forgotten</p>
        </div>
      <% end %>

      <%# Track on Mempool row %>
      <%= link_to "#",
            target: "_blank",
            class: "w-full flex items-center justify-between px-4 py-3 hover:bg-base-200 transition-colors",
            data: {
              controller: "binding",
              action: "bitcoin:changed@window->binding#attribute",
              binding_name_value: "public_address_text",
              binding_attribute_value: "href",
              binding_template_value: "https://mempool.space/address/{public_address_text}"
            } do %>
        <div class="flex items-center gap-3">
          <%= heroicon "arrow-top-right-on-square", variant: :outline, class: "w-5 h-5 text-base-content/70" %>
          <span class="text-base-content">Track on Mempool</span>
        </div>
        <%= heroicon "chevron-right", variant: :mini, class: "w-5 h-5 text-base-content/40" %>
      <% end %>

      <%# Save to My Hong₿aos row %>
      <%= link_to new_saved_hong_bao_path,
            target: "_blank",
            class: "w-full flex items-center justify-between px-4 py-3 hover:bg-base-200 transition-colors",
            data: {
              controller: "binding",
              action: "bitcoin:changed@window->binding#attribute",
              binding_name_value: "public_address_text",
              binding_attribute_value: "href",
              binding_template_value: "#{new_saved_hong_bao_path}?address={public_address_text}"
            } do %>
        <div class="flex items-center gap-3">
          <%= heroicon "bookmark", variant: :outline, class: "w-5 h-5 text-base-content/70" %>
          <span class="text-base-content">Save to My Hong₿aos</span>
        </div>
        <%= heroicon "chevron-right", variant: :mini, class: "w-5 h-5 text-base-content/40" %>
      <% end %>
    </div>
  </div>

  <%# Sticky bottom: Download + Fund %>
  <div class="sticky bottom-0 bg-base-100 border-t border-base-300 p-4 space-y-3 shadow-[0_-4px_20px_rgba(0,0,0,0.1)]">
    <%# Download PDF - Primary CTA %>
    <button type="button"
            class="btn btn-primary w-full"
            data-action="pdf#download">
      <%= heroicon "arrow-down-tray", class: "w-5 h-5" %>
      Download PDF
    </button>

    <%# Fund wallet - locked until download %>
    <%= render BottomSheetComponent.new(id: "fund-drawer") do |sheet| %>
      <% sheet.with_trigger do %>
        <button type="button"
                class="group w-full flex items-center justify-between px-4 py-3 rounded-lg border border-base-300 hover:bg-base-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-transparent"
                data-controller="disabled"
                data-action="pdf:downloaded@window->disabled#remove"
                disabled>
          <div class="flex items-center gap-3">
            <%= heroicon "banknotes", variant: :outline, class: "w-5 h-5 text-base-content/70" %>
            <span class="text-base-content">Fund wallet</span>
            <span class="text-base-content/40 text-xs group-enabled:hidden">(download first)</span>
          </div>
          <%= heroicon "chevron-right", variant: :mini, class: "w-5 h-5 text-base-content/40" %>
        </button>
      <% end %>
      <% sheet.with_header do %>Fund Your Wallet<% end %>
      <%= render "papers/show/drawers/fund" %>
    <% end %>
  </div>
</div>
