<%# Screen 1: Canvas - Design your paper wallet (New Editor Architecture) %>
<%#
  This uses the new paper-editor controller which manages both canvases
  with vanilla JS engine and canvas-rendered handles.
%>
<div class="<%= 'hidden' unless current_step == 1 %> flex flex-col h-[calc(100dvh-var(--canvas-offset))]"
     data-controller="paper-editor"
     data-paper-editor-design-value="<%= paper.elements.to_json %>"
     data-paper-editor-theme-id-value="<%= theme&.id %>"
     data-action="theme:changed@window->paper-editor#loadTheme bitcoin:changed@window->paper-editor#dataSourceChanged keydown@window->paper-editor#keydown"
     data-steps-target="content"
     data-steps-index="1">

  <%# Paper Editor Canvas Area %>
  <div class="flex-1 min-h-0 bg-base-200 p-4 flex flex-col">

    <%# Canvas Container - Layout adapts to frame orientation %>
    <div class="flex-1 min-h-0 <%= frame.portrait? ? 'flex flex-row gap-6 overflow-x-auto items-center justify-center' : 'flex flex-col gap-6 overflow-y-auto items-center justify-center' %>">

      <%# Front Canvas %>
      <div data-paper-editor-target="frontWrapper"
           class="shrink-0 rounded-lg shadow-xl overflow-hidden h-full aspect-[<%= frame.aspect_ratio %>] relative transition-opacity"
           data-side="front">
        <img src="<%= template_front_base64 %>"
             class="hidden"
             data-paper-editor-target="frontBackground" />
        <canvas data-paper-editor-target="frontCanvas"
                class="w-full h-full cursor-default"></canvas>
      </div>

      <%# Back Canvas %>
      <div data-paper-editor-target="backWrapper"
           class="shrink-0 rounded-lg shadow-xl overflow-hidden h-full aspect-[<%= frame.aspect_ratio %>] relative transition-opacity"
           data-side="back">
        <img src="<%= template_back_base64 %>"
             class="hidden"
             data-paper-editor-target="backBackground" />
        <canvas data-paper-editor-target="backCanvas"
                class="w-full h-full cursor-default"></canvas>
      </div>
    </div>

    <%# Hidden fields %>
    <%= hidden_field_tag "paper[elements]", paper.elements.to_json, data: { paper_editor_target: "field" } %>
    <%= hidden_field_tag "wallet_data", {}.to_json, data: { paper_editor_target: "dataSource" }, disabled: true %>

    <%# Side Toggle (optional - for single view mode) %>
    <div class="hidden">
      <button data-paper-editor-target="sideToggle"
              data-action="paper-editor#toggleSide"
              class="btn btn-sm btn-ghost">
        Front
      </button>
    </div>
  </div>

  <%# Bottom Toolbar %>
  <div id='toolbar' class="bg-base-100 border-t border-base-300 shadow-[0_-4px_20px_rgba(0,0,0,0.15)] px-4 py-3">
    <div class="flex items-center justify-between gap-2 max-w-3xl mx-auto">
      <%# Theme Selection Button %>
      <%= render BottomSheetComponent.new(id: "theme-drawer") do |sheet| %>
        <% sheet.with_trigger do %>
          <button type="button" class="btn btn-ghost btn-sm gap-1">
            <%= heroicon "swatch", variant: :mini, class: "w-4 h-4" %>
            <span class="hidden sm:inline">Theme</span>
          </button>
        <% end %>
        <div class="flex flex-col">
          <div class="py-4">
            <%= render ContentLoaderComponent.new(url: themes_path(current_id: theme.id), lazy_loading: true) %>
          </div>
          <div class="flex items-center justify-between px-4 py-3 border-t border-base-content/10 shrink-0">
            <form method="dialog">
              <button type="submit" class="btn btn-ghost btn-sm" data-action="click->theme-select#cancel">
                Cancel
              </button>
            </form>
            <span class="text-sm text-base-content/70">Theme</span>
            <form method="dialog">
              <button type="submit" class="btn btn-ghost btn-sm text-primary font-semibold" data-action="click->theme-select#confirm">
                Done
              </button>
            </form>
          </div>
        </div>
      <% end %>

      <%# Add Text Button %>
      <button type="button"
              class="btn btn-ghost btn-sm gap-1"
              data-action="paper-editor#addText">
        <%= heroicon "bars-3-bottom-left", variant: :mini, class: "w-4 h-4" %>
        <span class="hidden sm:inline">Text</span>
      </button>

      <%# Photo Selection Button %>
      <%= render BottomSheetComponent.new(id: "photo-drawer") do |sheet| %>
        <% sheet.with_trigger do %>
          <button type="button" class="btn btn-ghost btn-sm gap-1">
            <%= heroicon "photo", variant: :mini, class: "w-4 h-4" %>
            <span class="hidden sm:inline">Photo</span>
          </button>
        <% end %>
        <div class="h-[70vh] flex flex-col">
          <%= render "papers/new2/drawers/photo",
              recent_photos: recent_photos,
              pagy: pagy,
              styles: styles %>
        </div>
      <% end %>

      <%# Keys Button %>
      <%= render BottomSheetComponent.new(id: "keys-drawer") do |sheet| %>
        <% sheet.with_trigger do %>
          <button type="button" class="btn btn-ghost btn-sm gap-1">
            <%= heroicon "key", variant: :mini, class: "w-4 h-4" %>
            <span class="hidden sm:inline">Keys</span>
          </button>
        <% end %>
        <% sheet.with_footer(title: "Bitcoin Keys") %>
        <div class="p-4">
          <%= render "papers/show/drawers/keys" %>
        </div>
      <% end %>

      <%# QR Style Button %>
      <%= render BottomSheetComponent.new(id: "style-drawer") do |sheet| %>
        <% sheet.with_trigger do %>
          <button type="button" class="btn btn-ghost btn-sm gap-1">
            <%= heroicon "qr-code", variant: :mini, class: "w-4 h-4" %>
            <span class="hidden sm:inline">QR Style</span>
          </button>
        <% end %>
        <% sheet.with_footer(title: "QR Code Destination") %>
        <div class="p-4">
          <%= render "papers/show/drawers/style" %>
        </div>
      <% end %>

      <%# Next Button %>
      <button type="button"
              class="btn btn-primary btn-sm gap-1"
              data-action="paper-editor#exportForPreview steps#next">
        Next
        <%= heroicon "arrow-right", variant: :mini, class: "w-4 h-4" %>
      </button>
    </div>
  </div>

  <%# Text Edit Drawer %>
  <dialog id="text-edit-drawer" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-lg">Edit Text</h3>
        <form method="dialog">
          <button class="btn btn-sm btn-circle btn-ghost">
            <%= heroicon "x-mark", class: "w-5 h-5" %>
          </button>
        </form>
      </div>
      <%= render "papers/new2/drawers/text_edit" %>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
</div>
