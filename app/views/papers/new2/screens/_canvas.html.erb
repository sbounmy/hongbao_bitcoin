<%# Screen 1: Canvas - Design your paper wallet (Offline Mode) %>
<div class="<%= 'hidden' unless current_step == 1 %> flex flex-col h-[calc(100dvh-var(--canvas-offset))]"
     data-steps-target="content"
     data-steps-index="1">

  <%# Paper Preview - Layout adapts to frame orientation %>
  <div class="flex-1 min-h-0 bg-base-200 p-4 <%= frame.portrait? ? 'flex flex-row gap-6 overflow-x-auto items-center' : 'flex flex-col gap-6 overflow-y-auto items-center' %>">
    <%# Front Canvas - with portrait compositing support and editor %>
    <div class="shrink-0 rounded-lg shadow-xl overflow-hidden h-full aspect-[<%= frame.aspect_ratio %>]">
      <%= render 'papers/new2/paper_canva',
              frame: frame,
              paper: paper,
              theme: theme,
              elements: paper.front_elements,
              image_base64: template_front_base64,
              portrait_config: portrait_config,
              editor_enabled: true,
              side: "front"
      %>
    </div>

    <%# Back Canvas - with editor %>
    <div class="shrink-0 rounded-lg shadow-xl overflow-hidden h-full aspect-[<%= frame.aspect_ratio %>]">
      <%= render 'papers/new2/paper_canva',
              frame: frame,
              paper: paper,
              theme: theme,
              elements: paper.back_elements,
              image_base64: template_back_base64,
              editor_enabled: true,
              side: "back"
      %>
    </div>
  </div>

  <%# Bottom Toolbar - Extended with Photo button %>
  <div id='toolbar' class="bg-base-100 border-t border-base-300 shadow-[0_-4px_20px_rgba(0,0,0,0.15)] px-4 py-3">
    <div class="flex items-center justify-between gap-2 max-w-3xl mx-auto">
      <%# Theme Selection Button %>
      <%= render BottomSheetComponent.new(id: "theme-drawer") do |sheet| %>
        <% sheet.with_trigger do %>
          <button type="button" class="btn btn-ghost btn-sm gap-1">
            <%= heroicon "swatch", variant: :mini, class: "w-4 h-4" %>
            <span class="hidden sm:inline">Theme</span>
          </button>
        <% end %>
        <div class="flex flex-col">
          <%# Horizontal scroll theme list (lazy-loaded) %>
          <div class="py-4">
            <%= render ContentLoaderComponent.new(url: themes_path(current_id: theme.id), lazy_loading: true) %>
          </div>

          <%# Footer with Cancel/Done %>
          <div class="flex items-center justify-between px-4 py-3 border-t border-base-content/10 shrink-0">
            <form method="dialog">
              <button type="submit"
                      class="btn btn-ghost btn-sm"
                      data-action="click->theme-select#cancel">
                Cancel
              </button>
            </form>
            <span class="text-sm text-base-content/70">Theme</span>
            <form method="dialog">
              <button type="submit"
                      class="btn btn-ghost btn-sm text-primary font-semibold"
                      data-action="click->theme-select#confirm">
                Done
              </button>
            </form>
          </div>
        </div>
      <% end %>

      <%# Photo Selection Button - Opens bottom sheet %>
      <%= render BottomSheetComponent.new(id: "photo-drawer") do |sheet| %>
        <% sheet.with_trigger do %>
          <button type="button" class="btn btn-ghost btn-sm gap-1">
            <%= heroicon "photo", variant: :mini, class: "w-4 h-4" %>
            <span class="hidden sm:inline">Photo</span>
          </button>
        <% end %>
        <%# No header/footer - drawer manages its own Cancel/Done buttons %>
        <div class="h-[70vh] flex flex-col">
          <%= render "papers/new2/drawers/photo",
              recent_photos: recent_photos,
              pagy: pagy,
              styles: styles %>
        </div>
      <% end %>

      <%# Keys Button %>
      <%= render BottomSheetComponent.new(id: "keys-drawer") do |sheet| %>
        <% sheet.with_trigger do %>
          <button type="button" class="btn btn-ghost btn-sm gap-1">
            <%= heroicon "key", variant: :mini, class: "w-4 h-4" %>
            <span class="hidden sm:inline">Keys</span>
          </button>
        <% end %>
        <% sheet.with_footer(title: "Bitcoin Keys") %>
        <div class="p-4">
          <%= render "papers/show/drawers/keys" %>
        </div>
      <% end %>

      <%# QR Destination Button %>
      <%= render BottomSheetComponent.new(id: "style-drawer") do |sheet| %>
        <% sheet.with_trigger do %>
          <button type="button" class="btn btn-ghost btn-sm gap-1">
            <%= heroicon "qr-code", variant: :mini, class: "w-4 h-4" %>
            <span class="hidden sm:inline">QR Style</span>
          </button>
        <% end %>
        <% sheet.with_footer(title: "QR Code Destination") %>
        <div class="p-4">
          <%= render "papers/show/drawers/style" %>
        </div>
      <% end %>

      <%# Next Button %>
      <button type="button"
              class="btn btn-primary btn-sm gap-1"
              data-action="steps#next">
        Next
        <%= heroicon "arrow-right", variant: :mini, class: "w-4 h-4" %>
      </button>
    </div>
  </div>

  <%# Global Text Edit Drawer - Used by all text items %>
  <dialog id="text-edit-drawer" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-lg">Edit Text</h3>
        <form method="dialog">
          <button class="btn btn-sm btn-circle btn-ghost">
            <%= heroicon "x-mark", class: "w-5 h-5" %>
          </button>
        </form>
      </div>
      <%= render "papers/new2/drawers/text_edit" %>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
</div>
