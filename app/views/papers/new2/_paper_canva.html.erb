<%#
  Paper canvas with portrait compositing support.
  Extends the standard paper_canva with portrait position values for client-side compositing.
  Wrapped with editor controller for interactive editing (drag, resize, rotate).
%>
<%
  # Get canvas dimensions from frame
  frame = local_assigns[:frame] || Frame.new
  dimensions = frame.canvas_dimensions
  strict = local_assigns[:strict] || false
  editor_enabled = local_assigns.fetch(:editor_enabled, false)
%>
<div <% if editor_enabled %>
       data-controller="editor"
       data-editor-enabled-value="true"
     <% end %>
     class="relative w-full h-full">

  <div data-controller="canva"
       data-canva-width-value="<%= dimensions[:width] %>"
       data-canva-height-value="<%= dimensions[:height] %>"
       data-canva-strict-value="<%= strict %>"
       data-action="bitcoin:changed@window->canva#redraw canva:imageLoaded->bitcoin#dispatchWalletChanged<%= ' editor:changed@window->canva#handleElementsChanged' unless editor_enabled %>"
       class="w-full h-full">
    <%= image_tag image_base64, class: "hidden", data: { canva_target: "backgroundImage" } %>
    <canvas data-canva-target="container"
            data-editor-target="canvas"
            class="w-full h-full"></canvas>

    <% elements.each do |name, item| %>
      <%= render Canva::ItemComponent.for(name:, item:) %>
    <% end %>
  </div>

  <% if editor_enabled %>
    <%# Hover overlay - shows subtle border when hovering (desktop only) %>
    <div data-editor-target="hoverOverlay"
         class="hidden absolute pointer-events-none border-2 border-dashed border-primary/50 rounded-sm">
      <%# Label %>
      <span data-editor-target="hoverLabel"
            class="absolute -top-6 left-1/2 -translate-x-1/2 px-2 py-0.5 bg-primary/80 text-primary-content text-xs font-medium rounded whitespace-nowrap"></span>
    </div>

    <%# Selection overlay - shows border and handles when item is selected (desktop only) %>
    <div data-controller="editor--overlay"
         data-editor-target="selectionOverlay"
         class="hidden md:block absolute pointer-events-none rounded-sm"
         style="box-shadow: 0 0 0 2px hsl(var(--p)), 0 0 0 4px rgba(255,255,255,0.8);">

      <%# Label %>
      <span data-editor-target="selectionLabel"
            class="absolute -top-7 left-1/2 -translate-x-1/2 px-2 py-0.5 bg-primary text-primary-content text-xs font-medium rounded whitespace-nowrap shadow-md"></span>

      <%# Resize handles %>
      <div data-controller="editor--resize"
           data-action="editor--resize:start->editor#resizeStart editor--resize:move->editor#resizeMove editor--resize:end->editor#resizeEnd">
        <%# Corner handles - improved styling %>
        <div data-handle="nw" data-action="pointerdown->editor--resize#start"
             class="absolute -top-2 -left-2 w-4 h-4 bg-white border-2 border-primary rounded-sm cursor-nw-resize pointer-events-auto shadow-md hover:scale-110 transition-transform"></div>
        <div data-handle="ne" data-action="pointerdown->editor--resize#start"
             class="absolute -top-2 -right-2 w-4 h-4 bg-white border-2 border-primary rounded-sm cursor-ne-resize pointer-events-auto shadow-md hover:scale-110 transition-transform"></div>
        <div data-handle="sw" data-action="pointerdown->editor--resize#start"
             class="absolute -bottom-2 -left-2 w-4 h-4 bg-white border-2 border-primary rounded-sm cursor-sw-resize pointer-events-auto shadow-md hover:scale-110 transition-transform"></div>
        <div data-handle="se" data-action="pointerdown->editor--resize#start"
             class="absolute -bottom-2 -right-2 w-4 h-4 bg-white border-2 border-primary rounded-sm cursor-se-resize pointer-events-auto shadow-md hover:scale-110 transition-transform"></div>

        <%# Rotation handle - improved styling %>
        <div data-controller="editor--rotate"
             data-action="pointerdown->editor--rotate#start editor--rotate:start->editor#rotateStart editor--rotate:move->editor#rotateMove editor--rotate:end->editor#rotateEnd"
             class="absolute -top-10 left-1/2 -translate-x-1/2 w-6 h-6 bg-white border-2 border-primary rounded-full cursor-grab pointer-events-auto shadow-md hover:scale-110 transition-transform flex items-center justify-center">
          <svg class="w-3.5 h-3.5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
        </div>
        <%# Line from rotation handle to item %>
        <div class="absolute -top-8 left-1/2 w-0.5 h-6 bg-primary -translate-x-1/2 rounded-full"></div>
      </div>

      <%# Action buttons - positioned at bottom %>
      <div class="absolute -bottom-12 left-1/2 -translate-x-1/2 flex items-center gap-2 pointer-events-auto">
        <%# Edit button - opens drawer %>
        <button data-action="click->editor#editSelected"
                class="flex items-center gap-1.5 px-3 py-1.5 bg-white border-2 border-primary text-primary rounded-full shadow-md hover:bg-primary hover:text-white transition-colors text-sm font-medium">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
          <span class="hidden sm:inline">Edit</span>
        </button>

        <%# Delete button (only for non-presence items) %>
        <button data-editor--overlay-target="deleteBtn"
                data-action="click->editor#deleteSelected"
                class="flex items-center justify-center w-8 h-8 bg-white border-2 border-error text-error rounded-full shadow-md hover:bg-error hover:text-white transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </button>
      </div>
    </div>

    <%# Hidden field for persisting element positions %>
    <%= hidden_field_tag :elements, elements.to_json, data: { editor_target: "elementsField" } %>
  <% end %>
</div>
