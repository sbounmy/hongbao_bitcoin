<% content_for :skip_analytics, true %>

<% content_for :head do %>
  <meta name="robots" content="noindex, follow">
<% end %>

<% content_for :footer do %>
  <span class="text-white"></span>
<% end %>

<% attributes_for(:screen_attributes, {
  class: 'relative overflow-hidden group',
  data: {
    controller: 'steps bitcoin pdf portrait paper-editor',
    steps_current_value: @current_step.to_s,
    steps_hidden_class: 'hidden',
    bitcoin_auto_generate_value: 'true',
    bitcoin_network_value: Current.network.to_s,
    bitcoin_custom_wallet_value: 'false',
    bitcoin_hongbao_logo_value: asset_to_base64('hongbao-bitcoin.png'),
    bitcoin_bitcoin_logo_value: asset_to_base64('bitcoin-64x64.svg'),
    pdf_filename_value: "hongbao-#{@theme.slug}",
    paper_editor_design_value: @paper.elements.to_json,
    paper_editor_theme_id_value: @theme&.id,
    action: 'theme:changed@window->paper-editor#loadTheme bitcoin:changed@window->paper-editor#dataSourceChanged keydown@window->paper-editor#keydown'
  }
}) %>

<% content_for(:screen_header) do %>
  <%= render "papers/new2/headers/canvas", theme: @theme, current_step: @current_step, network: Current.network %>
  <%= render "papers/show/headers/finish", paper: @paper, current_step: @current_step, network: Current.network %>
<% end %>

<%= turbo_frame_tag "qr_scanner" %>

<%# Turbo Streams container for ActionCable subscriptions %>
<div id="turbo-streams"></div>

<%# Portrait AI generation loading indicator - non-blocking toast %>
<div data-portrait-target="loading" class="hidden toast toast-bottom toast-center z-50 mb-20">
  <div class="alert bg-base-100 shadow-xl border border-base-300 flex-col items-start gap-2 w-80">
    <div class="flex items-center gap-3 w-full">
      <span class="loading loading-spinner loading-sm text-primary"></span>
      <div class="flex-1">
        <p class="text-base-content font-medium text-sm">Creating your unique design</p>
        <p class="text-base-content/60 text-xs">This typically takes 45-60 seconds</p>
      </div>
    </div>
    <%= render ProgressBarComponent.new(animated: true, duration: 60, class: "w-full") %>
  </div>
</div>

<%# Portrait AI generation success notification %>
<div data-portrait-target="success" class="hidden toast toast-top toast-end z-50">
  <div class="alert alert-success">
    <%= heroicon "check-circle", variant: :mini, class: "w-5 h-5" %>
    <span>AI portrait ready!</span>
  </div>
</div>

<%# Storage controller - single source of truth for all elements %>
<div data-controller="editor-storage"
     data-action="canva:persist@window->editor-storage#handleCanvaPersist">
  <%= hidden_field_tag "elements", @paper.elements.to_json,
      data: { editor_storage_target: "field" } %>

  <%# Screen 1: Canvas - Paper preview with toolbar %>
  <%= render "papers/new2/screens/canvas",
      theme: @theme,
      frame: @frame,
      template_front_base64: @template_front_base64,
      template_back_base64: @template_back_base64,
      portrait_config: @portrait_config,
      paper: @paper,
      current_step: @current_step,
      recent_photos: @recent_photos,
      pagy: @pagy,
      styles: @styles %>

  <%# Screen 2: Finish - Download, Fund, Track %>
  <div class="<%= 'hidden' unless @current_step == 2 %> flex flex-col h-[calc(100dvh-var(--canvas-offset))]"
       data-steps-target="content"
       data-steps-index="2">
    <%= render "papers/new2/screens/finish",
        paper: @paper,
        frame: @frame,
        template_front_base64: @template_front_base64,
        template_back_base64: @template_back_base64,
        portrait_config: @portrait_config,
        current_step: @current_step %>
  </div>
</div>
