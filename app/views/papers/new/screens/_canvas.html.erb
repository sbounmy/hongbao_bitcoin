<%# Screen 1: Canvas - Design your paper wallet (DOM-based Editor) %>
<%#
  This uses the new DOM-based editor controller which renders elements
  as HTML/CSS for easier testing and better text rendering.
%>
<div class="<%= 'hidden' unless current_step == 1 %> flex flex-col h-[calc(100dvh-var(--canvas-offset))]"
     data-steps-target="content"
     data-steps-index="1">

  <%# Paper Editor Area - using tabs controller for front/back switching %>
  <div class="flex-1 min-h-0 bg-base-200 flex flex-col"
       data-controller="tabs"
       data-tabs-default-tab-value="front"
       data-tabs-active-class="ring-primary">

    <%# DOM Container - Single card view, scrollable for tall cards %>
    <div data-editor-target="layoutContainer"
         class="flex-1 min-h-0 flex items-start justify-center overflow-y-auto">

      <%# Front Container %>
      <div data-editor-target="frontWrapper"
           data-tabs-target="tab"
           data-tab-id="front"
           class="rounded-lg shadow-xl overflow-hidden aspect-[<%= frame.aspect_ratio %>] relative
                  w-full h-auto"
           data-side="front">
        <img src="<%= template_front_base64 %>"
             class="hidden"
             data-editor-target="frontBackground" />
        <div data-editor-target="frontContainer"
             class="w-full h-full cursor-default touch-none"
             style="container-type: inline-size;"></div>
      </div>

      <%# Back Container - hidden by default, tabs controller shows on select %>
      <div data-editor-target="backWrapper"
           data-tabs-target="tab"
           data-tab-id="back"
           class="hidden rounded-lg shadow-xl overflow-hidden aspect-[<%= frame.aspect_ratio %>] relative
                  w-full h-auto"
           data-side="back">
        <img src="<%= template_back_base64 %>"
             class="hidden"
             data-editor-target="backBackground" />
        <div data-editor-target="backContainer"
             class="w-full h-full cursor-default touch-none"
             style="container-type: inline-size;"></div>
      </div>
    </div>

    <%# Thumbnail Strip - Canva-style page navigation %>
    <div class="bg-base-200 px-4 py-2 flex justify-center gap-2">
      <%# Front Thumbnail %>
      <button type="button"
              data-tabs-target="btn"
              data-tab-id="front"
              data-action="tabs#select editor#switchSide"
              class="relative w-12 aspect-square rounded overflow-hidden
                     ring-2 ring-offset-2 ring-offset-base-200 ring-transparent
                     transition-all hover:scale-105">
        <div class="absolute inset-0 bg-cover bg-center"
             data-editor-target="frontThumbnail"
             style="background-image: url('<%= template_front_base64 %>');"></div>
        <span class="absolute bottom-0 inset-x-0 bg-base-content/80 text-base-100 text-[10px] py-px text-center">
          Front
        </span>
      </button>

      <%# Back Thumbnail %>
      <button type="button"
              data-tabs-target="btn"
              data-tab-id="back"
              data-action="tabs#select editor#switchSide"
              class="relative w-12 aspect-square rounded overflow-hidden
                     ring-2 ring-offset-2 ring-offset-base-200 ring-transparent
                     transition-all hover:scale-105">
        <div class="absolute inset-0 bg-cover bg-center"
             data-editor-target="backThumbnail"
             style="background-image: url('<%= template_back_base64 %>');"></div>
        <span class="absolute bottom-0 inset-x-0 bg-base-content/80 text-base-100 text-[10px] py-px text-center">
          Back
        </span>
      </button>
    </div>

    <%# Hidden fields %>
    <%= hidden_field_tag "paper[elements]", paper.elements.to_json, data: { editor_target: "field" } %>
    <%= hidden_field_tag "wallet_data", {}.to_json, data: { editor_target: "dataSource" }, disabled: true %>
  </div>

  <%# Bottom Toolbar %>
  <div id='toolbar' class="bg-base-100 border-t border-base-300 shadow-[0_-4px_20px_rgba(0,0,0,0.15)] px-4 pt-3">
    <div class="flex items-center justify-between gap-2 max-w-3xl mx-auto">
      <%# Theme Selection Button %>
      <%= render BottomSheetComponent.new(id: "theme-drawer") do |sheet| %>
        <% sheet.with_trigger do %>
          <button type="button" class="btn btn-ghost btn-sm gap-1">
            <%= heroicon "swatch", variant: :mini, class: "w-4 h-4" %>
            <span class="hidden sm:inline">Theme</span>
          </button>
        <% end %>
        <div class="flex flex-col">
          <div class="py-4">
            <%= render ContentLoaderComponent.new(url: themes_path(current_id: theme.id), lazy_loading: true) %>
          </div>
          <div class="flex items-center justify-between px-4 py-3 border-t border-base-content/10 shrink-0">
            <form method="dialog">
              <button type="submit" class="btn btn-ghost btn-sm" data-action="click->theme-select#cancel">
                Cancel
              </button>
            </form>
            <span class="text-sm text-base-content/70">Theme</span>
            <form method="dialog">
              <button type="submit" class="btn btn-ghost btn-sm text-primary font-semibold" data-action="click->theme-select#confirm">
                Done
              </button>
            </form>
          </div>
        </div>
      <% end %>

      <%# Photo Selection Button %>
      <%= render BottomSheetComponent.new(id: "photo-drawer") do |sheet| %>
        <% sheet.with_trigger do %>
          <button type="button" class="btn btn-ghost btn-sm gap-1">
            <%= heroicon "photo", variant: :mini, class: "w-4 h-4" %>
            <span class="hidden sm:inline">Photo</span>
          </button>
        <% end %>
        <div class="h-[70vh] flex flex-col">
          <%= render "papers/new/drawers/photo",
              recent_photos: recent_photos,
              pagy: pagy,
              styles: styles %>
        </div>
      <% end %>

      <%# Keys Button %>
      <%= render BottomSheetComponent.new(id: "keys-drawer") do |sheet| %>
        <% sheet.with_trigger do %>
          <button type="button" class="btn btn-ghost btn-sm gap-1">
            <%= heroicon "key", variant: :mini, class: "w-4 h-4" %>
            <span class="hidden sm:inline">Keys</span>
          </button>
        <% end %>
        <% sheet.with_footer(title: "Bitcoin Keys") %>
        <div class="p-4">
          <%= render "papers/new/drawers/keys" %>
        </div>
      <% end %>

      <%# QR Style Button %>
      <%= render BottomSheetComponent.new(id: "style-drawer") do |sheet| %>
        <% sheet.with_trigger do %>
          <button type="button" class="btn btn-ghost btn-sm gap-1">
            <%= heroicon "qr-code", variant: :mini, class: "w-4 h-4" %>
            <span class="hidden sm:inline">QR Style</span>
          </button>
        <% end %>
        <% sheet.with_footer(title: "QR Code Destination") %>
        <div class="p-4">
          <%= render "papers/new/drawers/style" %>
        </div>
      <% end %>

      <%# Next Button %>
      <button type="button"
              class="btn btn-primary btn-sm gap-1"
              data-action="editor#exportForPreview exportComplete@window->steps#next">
        Next
        <%= heroicon "arrow-right", variant: :mini, class: "w-4 h-4" %>
      </button>
    </div>
  </div>

  <%# Text Drawer - opened programmatically via editor, changes apply immediately %>
  <div data-controller="editor--text"
       data-action="editor:drawerOpen@window->editor--text#open">
    <%= render BottomSheetComponent.new(id: "text-drawer") do |sheet| %>
      <%# Header %>
      <div class="flex items-center justify-between px-4 pb-3 border-b border-base-content/10 shrink-0">
        <div class="font-semibold text-lg">Edit Text</div>
        <form method="dialog">
          <button class="btn btn-sm btn-circle btn-ghost">
            <%= heroicon "x-mark", class: "w-5 h-5" %>
          </button>
        </form>
      </div>

      <%# Content %>
      <div class="flex-1 overflow-auto p-4">
        <%= render "papers/new/drawers/text" %>
      </div>

      <%# Footer with Delete (left) and Done (right) %>
      <div class="flex items-center justify-between px-4 py-3 border-t border-base-content/10 shrink-0">
        <button type="button"
                class="btn btn-ghost btn-sm text-error"
                data-action="editor--text#delete"
                data-editor--text-target="deleteBtn">
          <%= heroicon "trash", variant: :mini, class: "w-4 h-4" %>
          Delete
        </button>
        <span class="text-sm text-base-content/70">Edit Text</span>
        <form method="dialog">
          <button type="submit" class="btn btn-ghost btn-sm text-primary font-semibold">Done</button>
        </form>
      </div>
    <% end %>
  </div>
</div>
