#!/usr/bin/env ruby
# frozen_string_literal: true

require 'vips'

class ImageCompositor
  DEFAULT_CONFIG = {
    x: 350,
    y: 80,
    width: 180,
    height: 240,
    quality: 90
  }.freeze

  def initialize(template_path, portrait_path, output_path = nil, config = {})
    @template_path = template_path
    @portrait_path = portrait_path
    @output_path = output_path || "output.jpg"
    @config = DEFAULT_CONFIG.merge(config)
  end

  def composite
    validate_files!

    # Load the bank note template
    puts "Loading template: #{@template_path}"
    template = Vips::Image.new_from_file(@template_path)

    # Load and prepare portrait
    puts "Loading portrait: #{@portrait_path}"
    portrait = prepare_portrait

    # Composite portrait onto template
    puts "Compositing at position (#{@config[:x]}, #{@config[:y]}) with size #{@config[:width]}x#{@config[:height]}..."
    result = template.composite(portrait, :over, x: @config[:x], y: @config[:y])

    # Save result
    puts "Saving to: #{@output_path}"
    result.write_to_file(@output_path, Q: @config[:quality])

    # Display stats
    display_stats(result)

    @output_path
  rescue => e
    puts "Error: #{e.message}"
    puts e.backtrace.first(5)
    exit 1
  end

  private

  def validate_files!
    unless File.exist?(@template_path)
      puts "Error: Template file not found: #{@template_path}"
      exit 1
    end

    unless File.exist?(@portrait_path)
      puts "Error: Portrait file not found: #{@portrait_path}"
      exit 1
    end
  end

  def prepare_portrait
    portrait = Vips::Image.new_from_file(@portrait_path)

    # Smart crop portrait to target dimensions
    # :attention mode focuses on interesting areas (faces, edges, saturation)
    portrait.thumbnail_image(@config[:width],
      height: @config[:height],
      crop: :attention
    )
  end

  def display_stats(image)
    file_size = File.size(@output_path)
    file_size_kb = (file_size / 1024.0).round(2)

    puts "\n" + "=" * 50
    puts "âœ“ Composite complete!"
    puts "=" * 50
    puts "Output file: #{File.expand_path(@output_path)}"
    puts "Dimensions:  #{image.width}x#{image.height}"
    puts "File size:   #{file_size_kb} KB"
    puts "=" * 50
  end
end

# Parse command-line arguments
def parse_args(args)
  if args.length < 2
    puts "Usage: bin/compositor.rb <template> <portrait> [output] [x,y,width,height]"
    puts ""
    puts "Arguments:"
    puts "  template  - Path to bank note template image"
    puts "  portrait  - Path to portrait image to composite"
    puts "  output    - (Optional) Output filename (default: output.jpg)"
    puts "  x,y,w,h   - (Optional) Position and size: x,y,width,height"
    puts ""
    puts "Examples:"
    puts "  # Basic usage with defaults"
    puts "  bin/compositor.rb thai-baht.png dbz.png"
    puts ""
    puts "  # Custom output filename"
    puts "  bin/compositor.rb thai-baht.png dbz.png result.jpg"
    puts ""
    puts "  # Full control over positioning"
    puts "  bin/compositor.rb thai-baht.png dbz.png output.jpg 350,80,180,240"
    puts ""
    puts "Default position: 350,80,180,240 (x=350, y=80, width=180, height=240)"
    exit 1
  end

  template = args[0]
  portrait = args[1]
  output = args[2] || "output.jpg"
  config = {}

  # Parse positioning if provided
  if args[3] && args[3].include?(',')
    x, y, width, height = args[3].split(',').map(&:to_i)
    config = { x: x, y: y, width: width, height: height }
  elsif args[2] && args[2].include?(',')
    # Handle case where output is omitted but position is provided
    x, y, width, height = args[2].split(',').map(&:to_i)
    config = { x: x, y: y, width: width, height: height }
    output = "output.jpg"
  end

  [template, portrait, output, config]
end

# Main execution
if __FILE__ == $0
  template, portrait, output, config = parse_args(ARGV)

  compositor = ImageCompositor.new(template, portrait, output, config)
  compositor.composite
end
